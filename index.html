<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0d1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stock Scan">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<title>Stock Scan</title>

  <style>
    body {
      background: #0d1117;
      color: #e5e7eb;
      font-family: "Segoe UI", Arial, Helvetica, sans-serif;
      padding: 16px 25px;
    }


    /* =======================
       Sticky Logo Header
       - åªå›ºå®šæœ€ä¸Šå±¤ Logo å€å¡Šï¼ˆheaderï¼‰
       ======================= */
    :root{ --header-h: 0px; }

    body{
      /* header å›ºå®šå¾Œï¼Œé¿å…å…§å®¹è¢«è“‹ä½ï¼ˆç”± JS è¨ˆç®— header é«˜åº¦ï¼‰ */
      padding-top: calc(16px + var(--header-h, 0px));
    }
    .header{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 800;
      background: #0d1117;
      padding: 10px 25px 8px;
      margin-bottom: 0;
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
    }

    /* Headerï¼šç½®ä¸­ Logo */
    .header{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-bottom:10px;
    }
    .header-logo{
      width:96px;
      max-width:70vw;
      height:auto;
      display:block;
      filter: drop-shadow(0 0 18px rgba(176,0,0,.28));
    }
    .subtitle{
      font-size:12px;
      line-height:1.2;
      color:#9ca3af;
      text-align:center;
      margin:0;
      margin-top:-2px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }
    #marketSelect,#filterMode,#sortKey{
      padding:7px 10px;
      border-radius:6px;
      border:1px solid #4b5563;
      background:#111827;
      color:#e5e7eb;
      outline:none;
    }
    #searchBox{
      padding:8px 12px;
      min-width:220px;
      border:1px solid #3b82f6;
      border-radius:6px;
      background:#111827;
      color:#e5e7eb;
      font-size:14px;
      outline:none;
      transition:.25s;
    }
    #searchBox::placeholder{ color:#6b7280; }
    #searchBox:focus{ box-shadow:0 0 8px #3b82f6; }
    #sortDirBtn{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:#111827;
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    #sortDirBtn:hover{ background:#1f2937; }

    /* ===== Sort direction icon (æ–¹æ¡ˆ C + å‹•ç•«) ===== */
.sort-anim{
  display:inline-block;
  --rot: 0deg;
  --lift: 0px;
  transform: translateY(var(--lift)) rotate(var(--rot));
  transition: transform .28s cubic-bezier(.34,1.56,.64,1), text-shadow .18s ease, color .18s ease;
  will-change: transform;
  font-size: 16px; /* ç®­é ­åŠ å¤§ä¸€é» */
  line-height: 1;

}
.sort-up{
  --lift: -2px; /* å‡å†ªï¼šå¾®æµ®èµ· */
  color:#22c55e;
  font-weight:1000;
  text-shadow:0 0 8px rgba(34,197,94,.65);
}
.sort-down{
  --lift: 2px; /* é™å†ªï¼šå¾®ä¸‹æ²‰ */
  color:#ef4444;
  font-weight:1000;
  text-shadow:0 0 8px rgba(239,68,68,.65);
}

/* æ‰‹æ©Ÿç«¯ï¼šé¡¯ç¤ºæ¨¡å¼åˆ‡æ›ï¼ˆå¡ç‰‡ / è¡¨æ ¼ï¼‰- Segmented */
    .segmented{
      display:none; /* æ¡Œæ©Ÿ/å¹³æ¿é è¨­ä¸é¡¯ç¤º */
      border:1px solid #4b5563;
      background:#0b1220;
      border-radius:999px;
      overflow:hidden;
      box-shadow:0 0 14px rgba(0,0,0,.25);
    }
    .seg-btn{
      appearance:none;
      border:0;
      padding:7px 14px;
      background:transparent;
      color:#e5e7eb;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:74px;
      transition: .18s ease;
    }
    .seg-btn:hover{
      background: rgba(31,41,55,.65);
    }
    .seg-btn.active{
      background: linear-gradient(90deg, rgba(59,130,246,.35), rgba(59,130,246,.75), rgba(59,130,246,.35));
      color:#0b1220;
      text-shadow: none;
    }

    .summary{ font-size:12px; color:#9ca3af; }

    /* å³ä¸Šè§’ï¼šåŠ æ¬ŠæŒ‡æ•¸å€å¡Š */
    .taiex-box{
      margin-left:auto;
      padding:8px 12px;
      border:1px solid rgba(148,163,184,.35);
      background: linear-gradient(90deg, rgba(17,24,39,.55), rgba(59,130,246,.18), rgba(17,24,39,.55));
      background-size: 220% 220%;
      animation: mpiSweep 2.0s ease-in-out infinite;
      border-radius:10px;
      min-width:320px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      box-shadow: 0 0 18px rgba(0,0,0,.35);
    }
    .taiex-name{ color:#93c5fd; font-size:12px; font-weight:800; letter-spacing:.3px; }
    .taiex-close{ color:#e5e7eb; font-size:15px; font-weight:950; }
    .taiex-chg{ font-size:13px; font-weight:900; padding:2px 8px; border-radius:999px; }
    .taiex-up{ color:#ef4444; background:rgba(239,68,68,.12); text-shadow:0 0 8px rgba(239,68,68,.35); }
    .taiex-down{ color:#22c55e; background:rgba(34,197,94,.12); text-shadow:0 0 8px rgba(34,197,94,.28); }
    .taiex-flat{ color:#9ca3af; background:rgba(156,163,175,.10); }
    .taiex-meta{ color:#9ca3af; font-size:11px; }


    table{
      width:100%;
      border-collapse:collapse;
      background:#111827;
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 0 18px rgba(0,0,0,.45);
    }

    /* =======================
       FIX: ç©©å®šã€Œè‚¡ç¥¨ä»£è™Ÿ / åç¨±ã€æ¬„å¯¬ï¼Œé¿å…ä¸åŒç¯©é¸æ¨¡å¼å› è³‡æ–™é›†åˆä¸åŒè€Œè‡ªå‹•é‡ç®—æ¬„å¯¬
       ======================= */
    table{ table-layout: fixed; }
    th:nth-child(1), td:nth-child(1){ width: 110px; } /* è‚¡ç¥¨ä»£è™Ÿ */
    th:nth-child(2), td:nth-child(2){ width: 160px; } /* åç¨± */

    th{
      background:#1f2937;
      padding:9px;
      font-size:13px;
      color:#93c5fd;
      text-align:center;
      border-bottom:1px solid #374151;
      white-space:nowrap;
    }
    td{
      padding:9px;
      text-align:center;
      border-bottom:1px solid #1f2937;
      color:#d1d5db;
      font-size:13px;
      white-space:nowrap;
    }
    tr:hover{ background:rgba(59,130,246,.15); }

    


    .disclaimer{
      margin-top: 18px;
      color:#9ca3af;
      font-size:12px;
      line-height:1.6;
      padding: 12px 12px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(17,24,39,.55);
      border-radius: 12px;
    }

.tag{
      background:#3b82f6;
      padding:3px 8px;
      color:white;
      border-radius:6px;
      font-weight:bold;
      box-shadow:0 0 10px rgba(59,130,246,.65);
    }

    /* ===== MPI badgeï¼ˆç§‘æŠ€æ„Ÿï¼‰ ===== */
    .mpi-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:34px;
      padding:3px 10px;
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.6px;
      border:1px solid rgba(148,163,184,.35);
      background: linear-gradient(90deg, rgba(17,24,39,.55), rgba(59,130,246,.18), rgba(17,24,39,.55));
      background-size: 220% 220%;
      animation: mpiSweep 2.0s ease-in-out infinite;
      box-shadow: 0 0 14px rgba(0,0,0,.35);
    }
    .mpi-S{ color:#ffd0d6; text-shadow:0 0 10px rgba(255,30,120,.55); border-color: rgba(255,30,120,.35); }
    .mpi-A{ color:#ffe9c7; text-shadow:0 0 10px rgba(249,115,22,.45); border-color: rgba(249,115,22,.30); }
    .mpi-B{ color:#d8ffe7; text-shadow:0 0 10px rgba(16,255,160,.45); border-color: rgba(16,255,160,.25); }
    .mpi-C{ color:#dbeafe; text-shadow:0 0 10px rgba(59,130,246,.45); border-color: rgba(59,130,246,.25); }
    .mpi-none{ color:#6b7280; }
/* æ©˜è‰²ï¼ˆåƒ¹æ ¼/é‡çš„é è¨­è‰²ï¼‰ */
    .value-orange{
      color:#f97316;
      font-weight:900;
      text-shadow:0 0 6px rgba(249,115,22,.55);
    }

    /* æ¼²åœï¼šç´… / è¢å…‰ç´…ï¼ˆè¦†è“‹ value-orangeï¼‰ */
    .value-red{
      color:#000; /* æ•¸å­—é»‘è‰² */
      font-weight:1000;
      letter-spacing:.2px;
      background:
        radial-gradient(140px 48px at 20% 10%, rgba(255,0,40,.55), rgba(0,0,0,0)),
        linear-gradient(90deg, rgba(255,0,0,.35), rgba(255,0,0,.92), rgba(255,0,0,.35));
      border-radius:12px;
      padding:2px 8px;
      box-shadow:
        0 0 0 1px rgba(255,70,70,.30) inset,
        0 0 18px rgba(255,0,0,.38);
    }
    @keyframes mpiSweep{
      0%{background-position:0% 50%; filter:brightness(1)}
      50%{background-position:100% 50%; filter:brightness(1.15)}
      100%{background-position:0% 50%; filter:brightness(1)}
    }

    @keyframes neonSweep{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    @keyframes neonFlicker{
      0%,100%{opacity:1; transform: translateY(-1px) scale(1)}
      45%{opacity:.82; transform: translateY(-1px) scale(1.02)}
      50%{opacity:.68; transform: translateY(-1px) scale(.98)}
      55%{opacity:.92; transform: translateY(-1px) scale(1.03)}
    }
    .value-neonred{
      /* âš¡ é–ƒé›»æ¨¡å¼ï¼šæ”¹æˆç´…åº•é»‘å­—ï¼ˆå’Œç´…è‰²æ¨¡å¼ä¸€è‡´ï¼‰ */
      color:#000;
      font-weight:1000;
      letter-spacing:.2px;
      background:
        radial-gradient(160px 52px at 25% 15%, rgba(255,0,40,.60), rgba(0,0,0,0)),
        linear-gradient(90deg, rgba(255,0,0,.42), rgba(255,0,0,.98), rgba(255,0,0,.42));
      border-radius:12px;
      padding:2px 8px;
      box-shadow:
        0 0 0 1px rgba(255,70,70,.35) inset,
        0 0 22px rgba(255,0,0,.55);
    }

    /* æ¼²åœ iconï¼ˆè·Ÿè‘—ç´…/è¢å…‰ç´…ï¼‰ */
    .limit-icons{
      display:inline-flex;
      align-items:center;
      gap:3px;
      margin-left:6px;
      transform: translateY(-1px);
      user-select:none;
    }
    .limit-iconss{
      display:inline-block;
      font-size:14px;
      line-height:1;
      letter-spacing:1px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.10));
    }
    .limit-iconss--lightning{
      padding:2px 8px;
      border-radius:999px;
      backdrop-filter: blur(6px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      background:
        radial-gradient(120px 40px at 20% 10%, rgba(176,0,0,.45), rgba(0,0,0,0)),
        linear-gradient(90deg, rgba(176,0,0,.22), rgba(122,0,0,.70), rgba(176,0,0,.22));
      filter: drop-shadow(0 0 16px rgba(176,0,0,.55));
      animation: neonFlicker 1.2s ease-in-out infinite;
    }
    /* ğŸ”¥ï¼šä¸éœ€è¦åº•è‰²ï¼Œåªè¦æ›´ç´…æ›´å…‡çš„ glow */
    .limit-iconss--fire{
      padding:0;
      border-radius:0;
      background: transparent;
      box-shadow:none;
      filter: drop-shadow(0 0 14px rgba(255,0,0,.55));
      animation: fireFlicker 1.1s ease-in-out infinite;
    }
    @keyframes fireFlicker{
      0%   { filter:brightness(1) saturate(1.05); }
      50%  { filter:brightness(1.22) saturate(1.30); }
      100% { filter:brightness(1) saturate(1.05); }
    }
    tr.hot-up{
      box-shadow: inset 5px 0 0 rgba(255,30,120,.95), inset 0 0 0 1px rgba(176,0,0,.10);
      animation: sideGlow 1.8s ease-in-out infinite;
    }
    tr.hot-down{
      box-shadow: inset 5px 0 0 rgba(16,255,160,.90), inset 0 0 0 1px rgba(90,255,170,.08);
      animation: sideGlow 1.8s ease-in-out infinite;
    }

    /* æ¼²è·Œå¹…ï¼šæ­£ç´…ã€è² ç¶ ï¼›|>=7| éœ“è™¹ */
    .chg-up{
      color:#ef4444; font-weight:950;
      text-shadow:0 0 8px rgba(239,68,68,.55);
      border-radius:10px;
      background: radial-gradient(120% 90% at 50% 50%, rgba(239,68,68,0.16), rgba(0,0,0,0) 70%);
    }
    .chg-down{
      color:#22c55e; font-weight:950;
      text-shadow:0 0 8px rgba(34,197,94,.55);
      border-radius:10px;
      background: radial-gradient(120% 90% at 50% 50%, rgba(34,197,94,0.14), rgba(0,0,0,0) 70%);
    }
    .chg-hot-up{
      color:#ffd0d6; font-weight:1000; letter-spacing:.4px;
      background:linear-gradient(90deg, rgba(239,68,68,.25), rgba(255,30,120,.62), rgba(239,68,68,.25));
      background-size:220% 220%;
      animation:neonSweep 1.6s ease-in-out infinite;
      border-radius:12px;
      text-shadow:0 0 14px rgba(176,0,0,1);
      box-shadow: inset 0 0 0 1px rgba(255,120,140,0.18), 0 0 18px rgba(176,0,0,0.12);
    }
    .chg-hot-down{
      color:#d8ffe7; font-weight:1000; letter-spacing:.4px;
      background:linear-gradient(90deg, rgba(34,197,94,.20), rgba(16,255,160,.55), rgba(34,197,94,.20));
      background-size:220% 220%;
      animation:neonSweep 1.6s ease-in-out infinite;
      border-radius:12px;
      text-shadow:0 0 14px rgba(34,197,94,1);
      box-shadow: inset 0 0 0 1px rgba(120,255,190,0.16), 0 0 18px rgba(34,197,94,0.10);
    }

    /* æŒ¯å¹…ï¼šæ­£ä¸”å‘ä¸Šç´… / æ­£ä¸”å‘ä¸‹ç¶  */
    .amp-up{
      color:#ef4444; font-weight:900;
      text-shadow:0 0 6px rgba(239,68,68,.4);
      border-radius:10px;
      background: radial-gradient(130% 95% at 50% 50%, rgba(239,68,68,0.12), rgba(0,0,0,0) 72%);
    }
    .amp-down{
      color:#22c55e; font-weight:900;
      text-shadow:0 0 6px rgba(34,197,94,.4);
      border-radius:10px;
      background: radial-gradient(130% 95% at 50% 50%, rgba(34,197,94,0.10), rgba(0,0,0,0) 72%);
    }

    .amp-zero{
      color:#8a8a8a;
      font-weight:800;
      letter-spacing:.2px;
    }

    .spark-cell{ padding:0; }

    a.stockLink{ color:#60a5fa; font-weight:bold; text-decoration:none; transition:.2s; }
    a.stockLink:hover{ color:#93c5fd; text-shadow:0 0 8px rgba(147,197,253,.8); }

    /* âœ… è‚¡åƒ¹ï¼ˆæ”¶ç›¤ï¼‰ç´…/ç¶ /ç°ï¼šåªæ”¹å­—è‰²ï¼Œä¸æ”¹åº•è‰²ï¼›å­—é‡èˆ‡ value-orange ä¸€è‡´ï¼ˆä¸å†è®Šç´°ï¼‰ */
    .price-up{
      color:#ff3b30 !important;
      font-weight:900;
      text-shadow:0 0 6px rgba(255,59,48,.55);
    }
    .price-down{
      color:#34c759 !important;
      font-weight:900;
      text-shadow:0 0 6px rgba(52,199,89,.45);
    }
    .price-flat{
      color:#9ca3af !important;
      font-weight:900;
      text-shadow:0 0 4px rgba(156,163,175,.35);
    }

    /* =======================
       Responsive (Mobile/Pad)
       ======================= */

    /* è®“è¡¨æ ¼åœ¨å°è¢å¹•å¯ä»¥å·¦å³æ»‘ï¼Œä¸çˆ†ç‰ˆ */
    .table-wrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
    }
    .table-wrap table{
      min-width: 980px; /* æ¡Œæ©Ÿæ­£å¸¸é¡¯ç¤ºï¼›æ‰‹æ©Ÿç”¨æ»‘å‹• */
    }

    /* Padï¼šç¸®å° paddingã€åŠ æ¬ŠæŒ‡æ•¸ä¸è¦ç¡¬å¡åœ¨å³é‚Š */
    @media (max-width: 980px){
      body{ padding-left: 12px; padding-right: 12px; }


      .taiex-box{
        margin-left: 0;
        min-width: 0;
        width: 100%;
        justify-content: space-between;
      }
    }

    /* Phoneï¼štoolbar ç›´æ’ï¼Œæ§åˆ¶é …å…¨å¯¬ï¼Œè¡¨æ ¼éš±è—éƒ¨åˆ†æ¬„ä½ */
    @media (max-width: 720px){
      /* æ‰‹æ©Ÿï¼šå¤šç•™ 6px ç·©è¡ï¼Œé¿å…é«˜åº¦å››æ¨äº”å…¥é€ æˆ toolbar è¢«å£“åˆ° */
      body{ padding-top: calc(16px + var(--header-h, 0px) + 6px); }
      .toolbar{ gap:10px; }

      /* toolbar å…§æ¯å€‹å€å¡Šéƒ½åƒæ»¿ */
      .toolbar > div{ width: 100%; }

      #marketSelect,#filterMode,#sortKey,#searchBox{
        width:100%;
        min-width: 0;
        box-sizing:border-box;
      }

      #sortDirBtn{
        width:100%;
        justify-content:center;
      }
      

      /* æ‰‹æ©Ÿï¼šæ’åºç®­é ­å†å¤§ä¸€é» */
      .sort-anim{ font-size: 18px; }
/* æ‰‹æ©Ÿï¼šè¡¨æ ¼ä¿ç•™æ‰€æœ‰æ¬„ä½ï¼ˆå¯å·¦å³æ»‘ï¼‰ */
      .table-wrap table{ min-width: 980px; }

      th, td{
        padding: 8px 6px;
        font-size: 12px;
      }

      .header-logo{ width: 84px; }
    }

  
    /* =======================
       Card view (Phone)
       ======================= */
    .cards{
      display:none; /* æ¡Œæ©Ÿé è¨­éš±è— */
      width:100%;
    }
    .card{
      background:#111827;
      border:1px solid rgba(148,163,184,.18);
      border-radius:14px;
      padding:12px 12px;
      box-shadow:0 0 18px rgba(0,0,0,.35);
    }
    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .card-name{
      font-weight:950;
      color:#e5e7eb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70vw;
    }
    .card-sub{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color:#9ca3af;
      font-size:12px;
    }
    .card-price{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
      text-align:right;
      margin-left:auto;
    }
    .card-price .p{
      font-size:18px;
      font-weight:1000;
    }
    .card-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
      margin-top:10px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 8px;
      border-radius:12px;
      background: rgba(31,41,55,.55);
      border: 1px solid rgba(148,163,184,.10);
    }
    .kv .k{
      color:#9ca3af;
      font-size:12px;
      white-space:nowrap;
    }
    .kv .v{
      color:#e5e7eb;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .card-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(148,163,184,.12);
    }
    .card-actions a{
      font-size:12px;
      text-decoration:none;
      color:#60a5fa;
      font-weight:900;
    }
    .card-actions a:hover{
      color:#93c5fd;
      text-shadow:0 0 8px rgba(147,197,253,.8);
    }

    /* Phoneï¼šé è¨­å¡ç‰‡ï¼Œå¯åˆ‡æ›è¡¨æ ¼ï¼ˆå·¦å³æ»‘ï¼‰ */
    @media (max-width: 720px){
      /* é¡¯ç¤ºåˆ‡æ›éˆ• */
      .segmented{ display:flex; width:100%; }
      .seg-btn{ flex:1; min-width:0; }

      /* å…©ç¨®æ¨¡å¼ï¼ˆé è¨­ï¼šmobile-view-cardsï¼‰ */
      body.mobile-view-cards .table-wrap{ display:none; }
      body.mobile-view-cards .cards{ display:flex; flex-direction:column; gap:12px; }

      body.mobile-view-table .table-wrap{ display:block; }
      body.mobile-view-table .cards{ display:none; }
    }

    /* =======================
       FIX: Mobile header overlay
       - é¿å… @media(max-width:980) æ”¹ padding å¾Œï¼Œheader å›ºå®šé€ æˆé®åˆ° toolbar
       - æ‰‹æ©Ÿç«¯ header å·¦å³ padding è·Ÿ body ä¸€è‡´
       ======================= */
    @media (max-width: 720px){
      .header{ padding-left: 12px; padding-right: 12px; }
    }

  </style>
</head>

<body>
  <div class="header">
    <img class="header-logo" id="logoBtn" src="logo.png" alt="SCAN logo" />
    <div class="subtitle" id="summaryText">è®€å–ä¸­â€¦</div>
  </div>

  <div class="toolbar">
    <div>
      <label for="marketSelect" style="font-size:12px; color:#9ca3af;">å¸‚å ´ï¼š</label>
      <select id="marketSelect">
        <option value="twse">ä¸Šå¸‚ (TWSE)</option>
        <option value="otc">ä¸Šæ«ƒ (OTC)</option>
      </select>
    </div>

    <div>
      <label for="filterMode" style="font-size:12px; color:#9ca3af;">ç¯©é¸æ¨¡å¼ï¼š</label>
      <select id="filterMode">
        <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
        <option value="limitup">æ¼²åœ</option>
        <option value="mpi">MPI æ¨™çš„</option>
      </select>
    </div>

    <input id="searchBox" placeholder="æœå°‹ä»£è™Ÿæˆ–åç¨±..." />

    <div>
      <label for="sortKey" style="font-size:12px; color:#9ca3af;">æ’åºæ¬„ä½ï¼š</label>
      <select id="sortKey">
        <option value="close">è‚¡åƒ¹</option>
        <option value="volume">æˆäº¤é‡</option>
        <option value="chg_pct">æ¼²è·Œå¹…%</option>
        <option value="amplitude_pct">æŒ¯å¹…%</option>
      </select>
    </div>

    <button id="sortDirBtn">æ’åºæ–¹å‘ï¼š<span id="sortDirLabel" class="sort-anim sort-down">â‡£</span></button>
    <div class="summary"><span id="countInfo"></span></div>
    <div class="segmented" id="viewSegment" role="tablist" aria-label="æ‰‹æ©Ÿé¡¯ç¤ºæ¨¡å¼åˆ‡æ›">
      <button id="viewCardsBtn" class="seg-btn" type="button" role="tab" aria-selected="true">å¡ç‰‡</button>
      <button id="viewTableBtn" class="seg-btn" type="button" role="tab" aria-selected="false">è¡¨æ ¼</button>
    </div>

  

    <div id="taiexBox" class="taiex-box" aria-label="åŠ æ¬ŠæŒ‡æ•¸">
      <span class="taiex-name">åŠ æ¬ŠæŒ‡æ•¸</span>
      <span class="taiex-close" id="taiexClose">â€”</span>
      <span class="taiex-chg taiex-flat" id="taiexChg">â€”</span>
      <span class="taiex-meta" id="taiexTime"></span>
    </div>

  </div>



  <div id="cardContainer" class="cards" aria-live="polite"></div>

  <div class="table-wrap">
    <table>
    <thead>
      <tr>
        <th>è‚¡ç¥¨ä»£è™Ÿ</th>
        <th>åç¨±</th>
        <th>è‚¡åƒ¹</th>
        <th>é–‹ç›¤</th>
        <th>æœ€é«˜</th>
        <th>æœ€ä½</th>
        <th>æ˜¨æ”¶</th>
        <th>æˆäº¤é‡</th>
        <th>MPI</th>
        <th>æ¼²è·Œå¹…%</th>
        <th>æŒ¯å¹…%</th>
        <th>å°èµ°å‹¢</th>
        <th>å¤§è‚¡æ±æŒè‚¡</th>
        <th>æ–°è</th>
      </tr>
    </thead>
    <tbody id="resultBody">
      <tr><td colspan="14">æ­£åœ¨è¼‰å…¥çµæœ...</td></tr>
    </tbody>
    </table>
  </div>

  <div class="disclaimer">è³‡è¨Šä¾†æºï¼šè‡ºç£è­‰åˆ¸äº¤æ˜“æ‰€ TWSEã€è²¡åœ˜æ³•äººä¸­è¯æ°‘åœ‹è­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒ GTSMã€‚ä½¿ç”¨è€…é ˆéµå®ˆå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ã€Œäº¤æ˜“è³‡è¨Šä½¿ç”¨ç®¡ç†è¾¦æ³•ã€ç­‰äº¤æ˜“è³‡è¨Šç®¡ç†ç›¸é—œè¦å®šï¼Œæ‰€æœ‰è³‡è¨Šä»¥å°ç£è­‰åˆ¸äº¤æ˜“æ‰€å…¬å‘Šè³‡æ–™ç‚ºä¸»ã€‚æœ¬ç¶²ç«™æä¾›ä¹‹è³‡æ–™åƒ…ä¾›åƒè€ƒï¼Œå°è³‡è¨Šæ­£ç¢ºã€å»¶é²æˆ–å‚³è¼¸ä¸­æ–·ä¸è² ä»»ä½•è²¬ä»»ï¼Œå¦‚ä½¿ç”¨è€…ä¾æœ¬è³‡æ–™äº¤æ˜“ç™¼ç”Ÿæå¤±éœ€è‡ªè¡Œè² è²¬</div>

  <script>
    let allRows = [];

    

    // ---------- Sticky header height ----------
    function applyHeaderHeight(){
      const header = document.querySelector(".header");
      if (!header) return;
      const hh = Math.ceil(header.getBoundingClientRect().height);
      document.documentElement.style.setProperty("--header-h", `${hh}px`);
    }
    window.addEventListener("resize", applyHeaderHeight);

    // ---------- Logo click: reset all controls to defaults ----------
    function resetToDefaults(){
      const marketSelect = document.getElementById("marketSelect");
      const filterMode = document.getElementById("filterMode");
      const sortKey = document.getElementById("sortKey");
      const searchBox = document.getElementById("searchBox");

      if (searchBox) searchBox.value = "";

      if (marketSelect) marketSelect.value = "twse";
      if (filterMode) filterMode.value = "all";
      if (sortKey) sortKey.value = "chg_pct";

      // Sort direction default: descending
      sortAsc = false;
      const label = document.getElementById("sortDirLabel");
      if (label){
        label.textContent = "â‡£";
        label.className = "sort-anim sort-down";
        label.style.setProperty("--rot", "0deg");
      }

      // æ‰‹æ©Ÿï¼šé è¨­å›åˆ°å¡ç‰‡æ¨¡å¼ï¼ˆè‹¥å­˜åœ¨è©²åŠŸèƒ½ï¼‰
      if (typeof setMobileViewMode === "function"){
        const isPhone = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
        if (isPhone) setMobileViewMode("cards");
      }

      loadData("twse");
    }

// ---------- helpers ----------
    function toNum(v){
      if (v === null || v === undefined || v === "") return NaN;
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }
    function eq(a,b){
      return Number.isFinite(a) && Number.isFinite(b) && Math.abs(a-b) < 0.001;
    }
    let sortAsc = false; // é è¨­é™å†ª
    let currentMarket = "twse";
    let currentFilterMode = "all";

    const numericKeys = new Set([
      "open","high","low","close","prev_close","volume","amplitude_pct","chg_pct"
    ]);

    let lastDateText = "â€”";
    let lastMarketDisplay = "";
    let lastMarketLabel = "";
    let lastTaiex = null;

    function renderTaiex(taiex){
      const closeEl = document.getElementById('taiexClose');
      const chgEl = document.getElementById('taiexChg');
      const timeEl = document.getElementById('taiexTime');
      if (!closeEl || !chgEl || !timeEl) return;
      if (!taiex || typeof taiex !== 'object' || !isFinite(Number(taiex.close))) {
        closeEl.textContent = 'â€”';
        chgEl.textContent = 'â€”';
        chgEl.className = 'taiex-chg taiex-flat';
        timeEl.textContent = '';
        return;
      }
      const close = Number(taiex.close);
      const chg = isFinite(Number(taiex.chg)) ? Number(taiex.chg) : 0;
      const chgPct = isFinite(Number(taiex.chg_pct)) ? Number(taiex.chg_pct) : null;
      closeEl.textContent = close.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
      let chgText = (chg>=0?'+':'') + chg.toFixed(2);
      if (chgPct !== null) chgText += ` (${(chgPct>=0?'+':'') + chgPct.toFixed(2)}%)`;
      chgEl.textContent = chgText;
      const cls = (chg>0) ? 'taiex-up' : (chg<0 ? 'taiex-down' : 'taiex-flat');
      chgEl.className = 'taiex-chg ' + cls;
      timeEl.textContent = taiex.time_text ? String(taiex.time_text) : '';
    }

    function getFilterModeLabel() {
      return "é¡¯ç¤ºå…¨éƒ¨";
    }

    async function loadData(market) {
      currentMarket = market;
      const tbody = document.getElementById("resultBody");
      const summaryText = document.getElementById("summaryText");
      const countInfo = document.getElementById("countInfo");

      tbody.innerHTML = "<tr><td colspan='14'>æ­£åœ¨è¼‰å…¥çµæœ...</td></tr>";
      countInfo.textContent = "";

      const filename = market === "twse" ? "results_twse.json" : "results_otc.json";
      const url = filename + "?v=" + new Date().getTime(); // é˜²å¿«å–

      try {
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) {
          tbody.innerHTML = `<tr><td colspan='14'>æ‰¾ä¸åˆ° ${filename}ï¼Œè«‹å…ˆç”¨ Python ç”¢ç”Ÿé€™å€‹æª”æ¡ˆã€‚</td></tr>`;
          summaryText.textContent = `ç„¡æ³•è®€å– ${filename}`;
          return;
        }

        const json = await resp.json();
        allRows = json.results || [];

        lastDateText = json.date || "â€”";
        lastMarketLabel = json.market || (market === "twse" ? "TWSE" : "OTC");
        lastMarketDisplay = market === "twse" ? "ä¸Šå¸‚" : "ä¸Šæ«ƒ";

        // åŠ æ¬ŠæŒ‡æ•¸ï¼ˆç”±å¾Œç«¯å¯«å…¥ json.taiexï¼‰
        lastTaiex = json.taiex || null;
        renderTaiex(lastTaiex);

        summaryText.textContent =
          `æ—¥æœŸï¼š${lastDateText}ï½œå¸‚å ´ï¼š${lastMarketDisplay} (${lastMarketLabel})`;

        

        applyHeaderHeight();
// é è¨­ç¯©é¸ï¼šé¡¯ç¤ºå…¨éƒ¨
        currentFilterMode = "all";
        document.getElementById("filterMode").value = "all";

        // é è¨­æ’åºï¼šæ¼²è·Œå¹…%
        document.getElementById("sortKey").value = "chg_pct";
        sortAsc = false;
        const label = document.getElementById("sortDirLabel");
        label.textContent = "â‡£";
        label.className = "sort-anim sort-down";
        renderSorted();

      } catch (e) {
        tbody.innerHTML = "<tr><td colspan='14'>è®€å–çµæœå¤±æ•—ï¼ˆè‹¥ç”¨ file:// é–‹å•Ÿï¼Œè«‹æ”¹ç”¨ http serverï¼‰ã€‚</td></tr>";
        summaryText.textContent = `è®€å– ${filename} æ™‚ç™¼ç”ŸéŒ¯èª¤`;
      }
    }

    function filterRowsByMode(rows) {
      const mode = document.getElementById("filterMode").value;
      if (mode === "limitup") {
        return (rows || []).filter(r => {
          const c = toNum(r.close);
          const u = toNum(r.limit_up ?? r.up_limit ?? r.upper_limit ?? r.limitUp ?? r.upperLimit ?? NaN);
          return u > 0 && eq(c, u);
        });
      }
      if (mode === "mpi") {
        return (rows || []).filter(r => {
          const v = (r.mpi ?? r.MPI ?? "").toString().trim();
          return v === "S" || v === "A" || v === "B" || v === "C";
        });
      }
      return rows;
    }

    function renderTable(rows) {
      const tbody = document.getElementById("resultBody");
      const countInfo = document.getElementById("countInfo");

      if (!rows || !rows.length) {
        tbody.innerHTML = "<tr><td colspan='14'>ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰è‚¡ç¥¨</td></tr>";
        countInfo.textContent = "ç›®å‰é¡¯ç¤ºï¼š0 æª”";
        return;
      }

      let html = "";
      rows.forEach(r => {
        const wantgoo = `https://www.wantgoo.com/stock/${r.ticker}`;
        const goodinfo = `https://goodinfo.tw/tw/StockDetail.asp?STOCK_ID=${r.ticker}`;

        const mpiVal = (r.mpi ?? r.MPI ?? "").toString().trim();
        const mpiText = mpiVal ? mpiVal : "â€”";


        const open  = Number(r.open);
        const high  = Number(r.high);
        const low   = Number(r.low);
        const close = toNum(r.close);
        const prevClose = Number(r.prev_close ?? r.prevClose ?? r.yclose ?? r.y_close ?? 0);

        // æˆäº¤é‡ï¼ˆæ©˜è‰²ï¼‰â€” å¾Œç«¯æ˜¯ã€Œè‚¡æ•¸ã€ï¼Œå‰ç«¯é¡¯ç¤ºã€Œå¼µæ•¸ã€(Ã·1000)
        const volNum = Number(r.volume || 0); // è‚¡
        const lots = volNum ? (volNum / 1000) : 0;
        const volText = lots ? lots.toLocaleString("en-US", { maximumFractionDigits: 0 }) : "â€”";

        // æ¼²è·Œå¹…ï¼ˆæ­£ç´…è² ç¶  + |>=7| éœ“è™¹ï¼›=0 é¡¯ç¤º zeroï¼‰
        const chgPctRaw = Number((r.chg_pct ?? r.change_pct ?? r.pct ?? r.changePct ?? 0));
        const chgPct = isFinite(chgPctRaw) ? chgPctRaw : 0;
        const isZeroChg = (chgPct === 0);
        const isHot = !isZeroChg && (Math.abs(chgPct) >= 7);
        const rowClass = isHot ? (chgPct >= 0 ? "hot-up" : "hot-down") : "";
        const chgClass = isZeroChg
          ? "amp-zero"
          : ((chgPct >= 0)
              ? (isHot ? "chg-hot-up" : "chg-up")
              : (isHot ? "chg-hot-down" : "chg-down"));
        const chgText = isZeroChg ? "zero" : ((chgPct >= 0 ? "+" : "") + chgPct.toFixed(2) + "%");

        // æŒ¯å¹…ï¼ˆæ­£ä¸”èµ°å‹¢å‘ä¸Šç´… / å‘ä¸‹ç¶ ï¼‰
        const ampRaw = Number(r.amplitude_pct ?? r.amp_pct ?? r.amplitude ?? NaN);
        const amp = Number.isFinite(ampRaw) ? ampRaw : NaN;
        const trendUp = (close >= open);
        let ampClass = "";
        let ampText = "-";
        if (Number.isFinite(amp)) {
          if (amp === 0) {
            ampClass = "amp-zero";
            ampText = "zero";
          } else {
            ampClass = (amp > 0) ? (trendUp ? "amp-up" : "amp-down") : "";
            ampText = amp.toFixed(2) + "%";
          }
        }

        // âœ… æ¼²åœåƒ¹ï¼ˆé—œéµï¼‰ï¼šå¦‚æœå¾Œç«¯æ²’çµ¦ï¼Œé€™æ®µå°±ä¸è§¸ç™¼ï¼ˆä¸æœƒèª¤åˆ¤ï¼‰
        const limitUp = toNum(
          r.limit_up ?? r.up_limit ?? r.upper_limit ?? r.limitUp ?? r.upperLimit ?? NaN
        );
        const isLimitClose = limitUp > 0 && eq(close, limitUp);

        // âœ… é€£çºŒæ¼²åœå¤©æ•¸ï¼ˆå¾Œç«¯è¨ˆç®—ï¼‰
        const streak = Number(r.limit_up_streak ?? r.limitUpStreak ?? 0) || 0;

        // âœ… ä½ çš„è¦å‰‡ï¼š
        // (3) è‚¡åƒ¹/é–‹ç›¤/æœ€é«˜/æœ€ä½ å…¨éƒ¨ == æ¼²åœåƒ¹ â†’ è¢å…‰ç´… + âš¡
        // (4) è‚¡åƒ¹/æœ€é«˜ == æ¼²åœåƒ¹ï¼Œä½†æœ€ä½ != æ¼²åœåƒ¹ â†’ ç´…è‰² + ğŸ”¥ï¼ˆæœ‰æ‰“é–‹éï¼‰
        const neonAll = (limitUp > 0)
          && eq(close, limitUp) && eq(open, limitUp) &&
             eq(high, limitUp)  && eq(low,  limitUp);

        const fireMode = (!neonAll)
          && (limitUp > 0)
          && eq(close, limitUp)
          && eq(high,  limitUp)
          && !eq(low,  limitUp);

        const showLightning = neonAll && isLimitClose;
        const showFire = fireMode && isLimitClose;

        // âœ… æ¼²åœ icon åºåˆ—ï¼ˆå¾Œç«¯æä¾›ï¼šä¿ç•™æ¯ä¸€å¤©çš„ icon é¡å‹ï¼‰
        const seq = Array.isArray(r.limit_up_icon_seq) ? r.limit_up_icon_seq
                  : (Array.isArray(r.limitUpIconSeq) ? r.limitUpIconSeq : []);

        let limitIconsHtml = "";
        if (isLimitClose) {
          if (seq && seq.length > 0) {
            const maxIcons = 12;
            const showSeq = seq.slice(-maxIcons); // å–æœ€å¾Œ maxIcons å¤©ï¼ˆè¶Šé å³è¶Šæ–°ï¼‰
            const extra = seq.length - showSeq.length;

            const iconsHtml = showSeq.map(it => {
              const icon = (it && it.icon) ? String(it.icon) : "";
              const kind = (it && (it.kind || it.type || it.mode)) ? String(it.kind || it.type || it.mode) :
                           (icon === "âš¡" ? "lightning" : (icon === "ğŸ”¥" ? "fire" : ""));
              const dateTxt = (it && it.date) ? String(it.date) : "";
              const title = dateTxt ? `${dateTxt}ï½œ${kind === "lightning" ? "é–æ­»âš¡" : (kind === "fire" ? "æ‰“é–‹ğŸ”¥" : "")}` : "";
              const cls = (kind === "lightning") ? "limit-iconss--lightning" : ((kind === "fire") ? "limit-iconss--fire" : "");
              return `<span class="limit-iconss ${cls}" title="${title}">${icon}</span>`;
            }).join("");

            limitIconsHtml = `<span class="limit-icons">${iconsHtml}${extra > 0 ? `<span class="limit-iconss amp-zero" title="é‚„æœ‰ ${extra} å¤©">+${extra}</span>` : ""}</span>`;
          } else {
            // fallbackï¼šè‹¥å¾Œç«¯æ²’æä¾›åºåˆ—ï¼Œå°±ç”¨ä»Šå¤© icon ä¾ streak é‡è¤‡ï¼ˆèˆŠé‚è¼¯ï¼‰
            const iconChar = showLightning ? "âš¡" : (showFire ? "ğŸ”¥" : "");
            const iconTitle = showLightning
              ? "è‚¡åƒ¹/é–‹ç›¤/æœ€é«˜/æœ€ä½ = æ¼²åœåƒ¹ï¼ˆå…¨ç¨‹é–æ­»ï¼‰"
              : (showFire ? "è‚¡åƒ¹/æœ€é«˜ = æ¼²åœåƒ¹ï¼Œä½†æœ€ä½æ›¾æ‰“é–‹" : "");
            const iconCount = iconChar ? (streak > 0 ? streak : 1) : 0;

            if (iconCount > 0) {
              const maxIcons = 12;
              const n = Math.min(iconCount, maxIcons);
              limitIconsHtml = `<span class="limit-icons">`
                + `<span class="limit-iconss ${showLightning ? "limit-iconss--lightning" : (showFire ? "limit-iconss--fire" : "")}" title="${iconTitle}">`
                + `${iconChar.repeat(n)}${iconCount > maxIcons ? ("+" + (iconCount - maxIcons)) : ""}`
                + `</span></span>`;
            }
          }
        }

        // åƒ¹æ ¼æ¬„ä½ class
        const prevCls  = "value-orange";
        const priceCls = showLightning
          ? "value-neonred"
          : (showFire
              ? "value-red"
              : (close > open ? "price-up" : (close < open ? "price-down" : "price-flat")));
        const openCls  = showLightning ? "value-neonred" : ((showFire && eq(open, limitUp)) ? "value-red" : "value-orange");
        const highCls  = showLightning ? "value-neonred" : (showFire ? "value-red" : "value-orange");
        const lowCls   = showLightning ? "value-neonred" : "value-orange";

        // å°èµ°å‹¢ï¼šå‘ä¸Šç´… / å‘ä¸‹ç¶ 
        const prices = [open, high, low, close].filter(v => v > 0);
        let sparkSvg = "-";
        if (prices.length === 4) {
          const minP = Math.min(...prices);
          const maxP = Math.max(...prices);
          const range = maxP - minP || 1;
          const mapY = v => 20 - ((v - minP) / range) * 14; // 6~20

          const p1 = `${5},${mapY(open)}`;
          const p2 = `${20},${mapY(high)}`;
          const p3 = `${40},${mapY(low)}`;
          const p4 = `${55},${mapY(close)}`;

          const color = trendUp ? "#ef4444" : "#22c55e";
          sparkSvg = `
            <svg width="60" height="24">
              <polyline
                points="${p1} ${p2} ${p3} ${p4}"
                fill="none"
                stroke="${color}"
                stroke-width="2"
                style="filter: drop-shadow(0 0 4px ${color});"
              />
            </svg>
          `;
        }

        // âœ… æ–°èï¼šåªç”¨è‚¡åï¼ˆä¸è¦è‡ªå¸¶ä»£è™Ÿï¼‰
        const qName = (r.name || "").trim();
        const googleNews = `https://www.google.com/search?q=${encodeURIComponent(qName)}&tbm=nws&tbs=qdr:d2`;
        const hasNews = r.has_recent_news === true;
        const newsSample = (r.news_sample_link || "").trim();
        let newsHtml = `<a href="${googleNews}" target="_blank" class="stockLink">Googleæ–°è</a>`;
        if (hasNews && newsSample) {
          newsHtml += `&nbsp;|&nbsp;<a href="${newsSample}" target="_blank" class="stockLink">æœ€æ–°ä¸€å‰‡</a>`;
        }

        html += `
          <tr class="${rowClass}">
            <td><a class="stockLink" href="${goodinfo}" target="_blank"><span class="tag">${r.ticker}</span></a></td>

            <td>
              <a href="${wantgoo}" target="_blank" class="stockLink">
                ${r.name || "â€”"}
              </a>
            </td>

            <!-- âœ… æ¬„ä½é †åºï¼šè‚¡åƒ¹ â†’ é–‹ç›¤ â†’ æœ€é«˜ â†’ æœ€ä½ â†’ æ˜¨æ”¶ -->
            <td class="${priceCls}">
              ${close ? close.toFixed(2) : "-"}
              ${limitIconsHtml}
            </td>
            <td class="${openCls}">${open ? open.toFixed(2) : "-"}</td>
            <td class="${highCls}">${high ? high.toFixed(2) : "-"}</td>
            <td class="${lowCls}">${low ? low.toFixed(2) : "-"}</td>
            <td class="${prevCls}">${prevClose ? prevClose.toFixed(2) : "-"}</td>

            <td class="value-orange">${volText}</td>

            <td>
              <span class="mpi-badge mpi-${mpiVal || 'none'}">${mpiText}</span>
            </td>

            <td class="${chgClass}">${chgText}</td>
            <td class="${ampClass}">${ampText}</td>

            <td class="spark-cell">${sparkSvg}</td>
            <td><a class="stockLink" href="https://norway.twsthr.info/stockholders.aspx?stock=${r.ticker}" target="_blank">æŸ¥çœ‹</a></td>
            <td>${newsHtml}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      countInfo.textContent = `ç›®å‰é¡¯ç¤ºï¼š${rows.length} æª”`;
    }


    function renderCards(rows){
      const container = document.getElementById("cardContainer");
      const countInfo = document.getElementById("countInfo");
      if (!container) return;

      if (!rows || !rows.length){
        container.innerHTML = `<div class="card"><div style="color:#9ca3af;font-size:13px;">ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰è‚¡ç¥¨</div></div>`;
        // countInfo ç”± applySearchFilter çµ±ä¸€è™•ç†
        return;
      }

      let html = "";
      rows.forEach(r => {
        const wantgoo = `https://www.wantgoo.com/stock/${r.ticker}`;
        const goodinfo = `https://goodinfo.tw/tw/StockDetail.asp?STOCK_ID=${r.ticker}`;

        const open  = Number(r.open);
        const high  = Number(r.high);
        const low   = Number(r.low);
        const close = toNum(r.close);
        const prevClose = Number(r.prev_close ?? r.prevClose ?? r.yclose ?? r.y_close ?? 0);

        const volNum = Number(r.volume || 0);
        const lots = volNum ? (volNum / 1000) : 0;
        const volText = lots ? lots.toLocaleString("en-US", { maximumFractionDigits: 0 }) : "â€”";

        const mpiVal = (r.mpi ?? r.MPI ?? "").toString().trim();
        const mpiText = mpiVal ? mpiVal : "â€”";

        const chgPctRaw = Number((r.chg_pct ?? r.change_pct ?? r.pct ?? r.changePct ?? 0));
        const chgPct = isFinite(chgPctRaw) ? chgPctRaw : 0;
        const isZeroChg = (chgPct === 0);
        const isHot = !isZeroChg && (Math.abs(chgPct) >= 7);
        const chgClass = isZeroChg
          ? "amp-zero"
          : ((chgPct >= 0)
              ? (isHot ? "chg-hot-up" : "chg-up")
              : (isHot ? "chg-hot-down" : "chg-down"));
        const chgText = isZeroChg ? "zero" : ((chgPct >= 0 ? "+" : "") + chgPct.toFixed(2) + "%");

        const ampRaw = Number(r.amplitude_pct ?? r.amp_pct ?? r.amplitude ?? NaN);
        const amp = Number.isFinite(ampRaw) ? ampRaw : NaN;
        const trendUp = (close >= open);
        let ampClass = "";
        let ampText = "-";
        if (Number.isFinite(amp)) {
          if (amp === 0) { ampClass = "amp-zero"; ampText = "zero"; }
          else { ampClass = (amp > 0) ? (trendUp ? "amp-up" : "amp-down") : ""; ampText = amp.toFixed(2) + "%"; }
        }

        const limitUp = toNum(r.limit_up ?? r.up_limit ?? r.upper_limit ?? r.limitUp ?? r.upperLimit ?? NaN);
        const isLimitClose = limitUp > 0 && eq(close, limitUp);
        const neonAll = (limitUp > 0) && eq(close, limitUp) && eq(open, limitUp) && eq(high, limitUp) && eq(low, limitUp);
        const fireMode = (!neonAll) && (limitUp > 0) && eq(close, limitUp) && eq(high, limitUp) && !eq(low, limitUp);
        const showLightning = neonAll && isLimitClose;
        const showFire = fireMode && isLimitClose;

        const seq = Array.isArray(r.limit_up_icon_seq) ? r.limit_up_icon_seq
                  : (Array.isArray(r.limitUpIconSeq) ? r.limitUpIconSeq : []);
        let limitIconsHtml = "";
        if (isLimitClose) {
          if (seq && seq.length > 0) {
            const maxIcons = 12;
            const showSeq = seq.slice(-maxIcons);
            const extra = seq.length - showSeq.length;
            const iconsHtml = showSeq.map(it => {
              const icon = (it && it.icon) ? String(it.icon) : "";
              const kind = (it && (it.kind || it.type || it.mode)) ? String(it.kind || it.type || it.mode) :
                           (icon === "âš¡" ? "lightning" : (icon === "ğŸ”¥" ? "fire" : ""));
              const dateTxt = (it && it.date) ? String(it.date) : "";
              const title = dateTxt ? `${dateTxt}ï½œ${kind === "lightning" ? "é–æ­»âš¡" : (kind === "fire" ? "æ‰“é–‹ğŸ”¥" : "")}` : "";
              const cls = (kind === "lightning") ? "limit-iconss--lightning" : ((kind === "fire") ? "limit-iconss--fire" : "");
              return `<span class="limit-iconss ${cls}" title="${title}">${icon}</span>`;
            }).join("");
            limitIconsHtml = `<span class="limit-icons">${iconsHtml}${extra > 0 ? `<span class="limit-iconss amp-zero" title="é‚„æœ‰ ${extra} å¤©">+${extra}</span>` : ""}</span>`;
          } else {
            const iconChar = showLightning ? "âš¡" : (showFire ? "ğŸ”¥" : "");
            const iconTitle = showLightning
              ? "è‚¡åƒ¹/é–‹ç›¤/æœ€é«˜/æœ€ä½ = æ¼²åœåƒ¹ï¼ˆå…¨ç¨‹é–æ­»ï¼‰"
              : (showFire ? "è‚¡åƒ¹/æœ€é«˜ = æ¼²åœåƒ¹ï¼Œä½†æœ€ä½æ›¾æ‰“é–‹" : "");
            if (iconChar) {
              limitIconsHtml = `<span class="limit-icons"><span class="limit-iconss ${showLightning ? "limit-iconss--lightning" : (showFire ? "limit-iconss--fire" : "")}" title="${iconTitle}">${iconChar}</span></span>`;
            }
          }
        }

        const priceCls = showLightning
          ? "value-neonred"
          : (showFire ? "value-red" : (close > open ? "price-up" : (close < open ? "price-down" : "price-flat")));

        const qName = (r.name || "").trim();
        const googleNews = `https://www.google.com/search?q=${encodeURIComponent(qName)}&tbm=nws&tbs=qdr:d2`;
        const hasNews = r.has_recent_news === true;
        const newsSample = (r.news_sample_link || "").trim();

        const norway = `https://norway.twsthr.info/stockholders.aspx?stock=${r.ticker}`;

        // æœå°‹ç”¨æ–‡å­—ï¼ˆåŒæ™‚å«ä»£è™Ÿ/åç¨±ï¼‰
        const searchText = `${String(r.ticker||"")} ${String(r.name||"")}`.toLowerCase();

        html += `
          <div class="card" data-search="${searchText}">
            <div class="card-top">
              <div class="card-title">
                <div class="card-name">
                  <a class="stockLink" href="${wantgoo}" target="_blank">${r.name || "â€”"}</a>
                </div>
                <div class="card-sub">
                  <a class="stockLink" href="${goodinfo}" target="_blank"><span class="tag">${r.ticker}</span></a>
                  <span class="${chgClass}">${chgText}</span>
                  <span class="mpi-badge mpi-${mpiVal || 'none'}">${mpiText}</span>
                </div>
              </div>

              <div class="card-price">
                <div class="p ${priceCls}">
                  ${close ? close.toFixed(2) : "-"}
                  ${limitIconsHtml}
                </div>
                <div class="summary">${volText} å¼µ</div>
              </div>
            </div>

            <div class="card-grid">
              <div class="kv"><span class="k">é–‹ç›¤</span><span class="v value-orange">${open ? open.toFixed(2) : "-"}</span></div>
              <div class="kv"><span class="k">æœ€é«˜</span><span class="v value-orange">${high ? high.toFixed(2) : "-"}</span></div>
              <div class="kv"><span class="k">æœ€ä½</span><span class="v value-orange">${low ? low.toFixed(2) : "-"}</span></div>
              <div class="kv"><span class="k">æ˜¨æ”¶</span><span class="v value-orange">${prevClose ? prevClose.toFixed(2) : "-"}</span></div>
              <div class="kv"><span class="k">æŒ¯å¹…</span><span class="v ${ampClass}">${ampText}</span></div>
              <div class="kv"><span class="k">èµ°å‹¢</span><span class="v">${(() => {
                const prices = [open, high, low, close].filter(v => v > 0);
                if (prices.length !== 4) return "-";
                const minP = Math.min(...prices);
                const maxP = Math.max(...prices);
                const range = maxP - minP || 1;
                const mapY = v => 20 - ((v - minP) / range) * 14;
                const p1 = `${5},${mapY(open)}`;
                const p2 = `${20},${mapY(high)}`;
                const p3 = `${40},${mapY(low)}`;
                const p4 = `${55},${mapY(close)}`;
                const color = (close >= open) ? "#ef4444" : "#22c55e";
                return `
                  <svg width="60" height="24" style="vertical-align:middle;">
                    <polyline points="${p1} ${p2} ${p3} ${p4}" fill="none" stroke="${color}" stroke-width="2"
                      style="filter: drop-shadow(0 0 4px ${color});" />
                  </svg>
                `;
              })()}</span></div>
            </div>

            <div class="card-actions">
              <a href="${googleNews}" target="_blank">Googleæ–°è</a>
              ${hasNews && newsSample ? `<a href="${newsSample}" target="_blank">æœ€æ–°ä¸€å‰‡</a>` : ""}
              <a href="${norway}" target="_blank">å¤§è‚¡æ±</a>
              <a href="${goodinfo}" target="_blank">Goodinfo</a>
              <a href="${wantgoo}" target="_blank">ç©è‚¡ç¶²</a>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }


    function renderSorted() {
      const key = document.getElementById("sortKey").value;
      const dir = sortAsc ? 1 : -1;

      const rowsCopy = [...allRows];
      rowsCopy.sort((a, b) => {
        let va = a[key], vb = b[key];
        if (va === undefined || va === null || va === "") va = numericKeys.has(key) ? 0 : "";
        if (vb === undefined || vb === null || vb === "") vb = numericKeys.has(key) ? 0 : "";

        if (numericKeys.has(key)) return dir * ((Number(va) || 0) - (Number(vb) || 0));
        return dir * String(va).localeCompare(String(vb), "zh-Hant");
      });

      const filtered = filterRowsByMode(rowsCopy);
      renderTable(filtered);
      renderCards(filtered);
      applySearchFilter();
      updateSummaryWithFilter(filtered.length);
    }

    function applySearchFilter() {
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

      // Table rows
      const trs = document.querySelectorAll("#resultBody tr");
      let visibleTable = 0;
      trs.forEach(tr => {
        const text = tr.innerText.toLowerCase();
        const show = text.includes(keyword);
        tr.style.display = show ? "" : "none";
        if (show) visibleTable++;
      });

      // Card view
      const cards = document.querySelectorAll("#cardContainer .card");
      let visibleCards = 0;
      cards.forEach(card => {
        const text = (card.getAttribute("data-search") || card.innerText || "").toLowerCase();
        const show = text.includes(keyword);
        card.style.display = show ? "" : "none";
        if (show) visibleCards++;
      });

      // é¡¯ç¤ºæ•¸é‡ï¼šæ¡Œæ©Ÿç”¨è¡¨æ ¼ï¼›æ‰‹æ©Ÿä¾ã€Œé¡¯ç¤ºæ¨¡å¼ã€æ±ºå®šç”¨å¡ç‰‡æˆ–è¡¨æ ¼
      const isPhone = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
      let visible = visibleTable;
      if (isPhone) {
        const useTable = document.body.classList.contains("mobile-view-table");
        visible = useTable ? visibleTable : visibleCards;
      }

      document.getElementById("countInfo").textContent = `ç›®å‰é¡¯ç¤ºï¼š${visible} æª”`;
    }

    function updateSummaryWithFilter(count) {
      const summaryText = document.getElementById("summaryText");
      summaryText.textContent =
        `æ—¥æœŸï¼š${lastDateText}ï½œå¸‚å ´ï¼š${lastMarketDisplay} (${lastMarketLabel})`;
    }

    document.getElementById("sortKey").addEventListener("change", renderSorted);

    document.getElementById("sortDirBtn").addEventListener("click", () => {
  sortAsc = !sortAsc;

  const label = document.getElementById("sortDirLabel");

  // å…ˆæ›´æ–°ç‹€æ…‹ï¼ˆæ–‡å­— + ä¸Šä¸‹æµ®æ²‰è‰²ï¼‰
  if (sortAsc){
    label.textContent = "â‡¡";
    label.className = "sort-anim sort-up";
  } else {
    label.textContent = "â‡£";
    label.className = "sort-anim sort-down";
  }

  // é»æ“Šæ™‚ï¼šå¾®æ—‹è½‰ 180Â°ï¼ˆä¸å½±éŸ¿ translateYï¼‰
  label.style.setProperty("--rot", "0deg");
  // å¼·åˆ¶ reflowï¼Œç¢ºä¿æ¯æ¬¡é»æ“Šéƒ½èƒ½è§¸ç™¼å‹•ç•«
  void label.offsetWidth;
  label.style.setProperty("--rot", "180deg");
  setTimeout(() => {
    label.style.setProperty("--rot", "0deg");
  }, 180);

  renderSorted();
});

document.getElementById("searchBox").addEventListener("input", applySearchFilter);

    document.getElementById("marketSelect").addEventListener("change", (e) => {
      loadData(e.target.value);
    });

    document.getElementById("filterMode").addEventListener("change", (e) => {
      currentFilterMode = e.target.value;
      renderSorted();
    });


    function setMobileViewMode(mode){
      // mode: "cards" | "table"
      if (mode === "table"){
        document.body.classList.add("mobile-view-table");
        document.body.classList.remove("mobile-view-cards");
        localStorage.setItem("mobileViewMode", "table");
      } else {
        document.body.classList.add("mobile-view-cards");
        document.body.classList.remove("mobile-view-table");
        localStorage.setItem("mobileViewMode", "cards");
      }
      updateSegmentActive();
      applySearchFilter();
    }

    function updateSegmentActive(){
      const btnCards = document.getElementById("viewCardsBtn");
      const btnTable = document.getElementById("viewTableBtn");
      if (!btnCards || !btnTable) return;
      const useTable = document.body.classList.contains("mobile-view-table");
      btnCards.classList.toggle("active", !useTable);
      btnTable.classList.toggle("active", useTable);
      btnCards.setAttribute("aria-selected", useTable ? "false" : "true");
      btnTable.setAttribute("aria-selected", useTable ? "true" : "false");
    }

    function initMobileViewToggle(){
      const isPhone = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;

      // æ¡Œæ©Ÿ/å¹³æ¿ï¼šä¸ä½¿ç”¨æ‰‹æ©Ÿæ¨¡å¼ classï¼ˆæ¡Œæ©Ÿå°±é¡¯ç¤ºè¡¨æ ¼ï¼‰
      if (!isPhone){
        document.body.classList.remove("mobile-view-cards","mobile-view-table");
        return;
      }

      // æ‰‹æ©Ÿï¼šé è¨­å¡ç‰‡ï¼›è‹¥æœ‰è¨˜éŒ„å‰‡æ²¿ç”¨
      const saved = (localStorage.getItem("mobileViewMode") || "").toLowerCase();
      const mode = (saved === "table") ? "table" : "cards";
      setMobileViewMode(mode);

      const btnCards = document.getElementById("viewCardsBtn");
      const btnTable = document.getElementById("viewTableBtn");
      if (btnCards) btnCards.addEventListener("click", () => setMobileViewMode("cards"));
      if (btnTable) btnTable.addEventListener("click", () => setMobileViewMode("table"));
    }

    initMobileViewToggle();
    // ç¶å®š Logo é»æ“Šï¼šæ¢å¾©é è¨­
    const logo = document.getElementById("logoBtn");
    if (logo){
      logo.addEventListener("click", resetToDefaults);
    }

    applyHeaderHeight();
    loadData("twse");
  </script>

<script>
  // PWA: Service Worker registration (GitHub Pages friendly)
  (function () {
    if (!("serviceWorker" in navigator)) return;
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(() => {});
    });
  })();
</script>
</body>
</html>